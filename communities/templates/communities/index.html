{% extends "core/base.html" %}

{% block content %}


<div class = "container border border-primary rounded">
	<h1 class = "text-hover">Here are your communities.</h1>
	<h4>
		<p id = "p__show-hide-create-post">Create Post</p>
		<div class = "container border border-primary rounded" id = "div__create-post" style="display:none">
			<form method = "POST">
				{% csrf_token %}
				{{formPostForm.as_p}}
				<input type = "submit" value = "Save Post">
			</form>
		</div>
	</h4>
</div>

<br>

<div class = "container border border-primary rounded">
	<h1 class = "text-center">
		<a href = "{% url 'communities:request_help' %}">
			Request help.
		</a>
	</h1>
</div>

<br>

<div class = "container border border-primary rounded pb-4">
	<div id = "div__communities-recent-post-container">
		<h4 class = "pl-4">Recent posts:</h4>
		<div class = "row">
			<div class = "col">
				{% for modelPost in listModelPosts %}
					<div id = "div__post${{modelPost.id}}" class = "div__communities-post">
						<img style="height:10%;width:10%"  class = "rounded-circle img__users-profile-img" src = "{{modelPost.author.profile_picture.url}}">
						<a href = "{% url 'communities:profile' modelPost.author.username %}">
							{{modelPost.author}}
						</a> on {{modelPost.pub_date}}
						<br>
						<a href = "{% url 'communities:post_detail' modelPost.author.username modelPost.slug %}" class = "p__communities-post-title">
							{{modelPost.title}}
						</a>
						<br>

						<div class = "container border border-primary rounded">
							<p>{{modelPost.text_content}}</p>
						</div>

						<div id = "div__post-{{modelPost.id}}-likes">
							{% if user in modelPost.user_likes.all %}
								<button  data-url = "{% url 'communities:like_post' modelPost.id %}" class = "btn__like-post btn__like-post--active" id = "btn__like-post${{modelPost.id}}">
									Like
								</button>
							{% else %}
								<button  data-url = "{% url 'communities:like_post' modelPost.id %}" class = "btn__like-post btn__like-post--inactive" id = "btn__like-post${{modelPost.id}}">Like</button>
							{% endif %}
						</div>
						Total Comments: {{modelPost.comments.count}}
						{% if modelPost.author == user %}
							<p style="color:rgb(185, 43, 43);" class = "btn__delete-post" data-url = "{% url 'communities:delete_post' modelPost.id %}">
								Delete?
							</p>
						{% endif %}
					</div>
				{% endfor %}
			</div>
		</div>

	</div>
</div>


{% endblock content %}

{% block javascript %}

<script>
	function delete_post(strUrl){
		let strPostId = strUrl.split("\/").pop();
		let divPost = document.getElementById('div__post$' + strPostId);
		divPost.style.display = "none"

		$.ajax({
			url:strUrl,
		})
	}

	function update_post(strUrl){
		let strPostId = strUrl.split('\/').pop();
		let btn = document.getElementById("btn__like-post$" + strPostId)
		$.ajax({
			url:strUrl,
			success: function(){
				location.reload();
			}
		})
	}
	
	function show_hide_create_post_field(divShowHide,pClicker){
		if(divShowHide.style.display == "none"){
			divShowHide.style.display = "block";
			pClicker.innerText = "Cancel";
		}
		else{
			divShowHide.style.display = "none";
			pClicker.innerText = "Create Post";
		}
	}
	// associate p show hide create post with func
	let pShowHideCreatePost = document.getElementById("p__show-hide-create-post");
	pShowHideCreatePost.addEventListener("click",()=>{
		let divCreatePost = document.getElementById("div__create-post");
		show_hide_create_post_field(divCreatePost,pShowHideCreatePost);
	});

	// associating delete buttons with function
	let arrbtnsDelete = document.getElementsByClassName("btn__delete-post");
	for(let btn of arrbtnsDelete){
		let strUrl = btn.getAttribute('data-url');
		btn.addEventListener('click',()=>{
			delete_post(strUrl);
		})
	}

	// associating like buttons with function
	let arrbtnsLike = document.getElementsByClassName("btn__like-post")
	for(let btn of arrbtnsLike){
		// get the id
		let strUrl = btn.getAttribute("data-url");
		btn.addEventListener("click",()=>{
			update_post(strUrl);
		})
	}

</script>
{% endblock javascript %}

